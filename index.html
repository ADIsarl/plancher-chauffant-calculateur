<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADI - Calculateur de Plancher Chauffant Pro v4.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4a7ba7 0%, #6998bd 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Header avec logo ADI */
        .header {
            background: linear-gradient(135deg, #1e4d8b 0%, #2a5ea5 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            background: white;
            padding: 12px 25px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-text {
            font-family: 'Mistral', 'Brush Script MT', cursive;
            font-size: 2.5em;
            font-weight: bold;
            font-style: italic;
            display: flex;
            align-items: baseline;
        }

        .logo-letter {
            margin: 0;
        }

        .letter-a {
            color: #1e4d8b;
        }

        .letter-d {
            color: #dc3545;
        }

        .letter-i {
            color: #00a8e8;
        }

        .logo-point {
            color: #333;
            font-size: 1em;
            font-weight: bold;
            margin: 0 5px;
            position: relative;
            bottom: -2px;
        }

        .logo-subtitle {
            font-family: Arial, sans-serif;
            font-size: 0.6em;
            color: #666;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .header-title {
            flex: 1;
            color: white;
        }

        .header-title h1 {
            font-size: 1.6em;
            margin-bottom: 5px;
        }

        .header-title p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .project-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            position: relative;
        }

        .project-controls button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .project-controls button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* Section Client */
        .client-section {
            background: #2c5f9e;
            padding: 15px 30px;
            color: white;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .client-inputs {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .client-inputs label {
            font-weight: 500;
        }

        .client-inputs input {
            background: rgba(255,255,255,0.95);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 1em;
            width: 180px;
        }

        /* Param√®tres g√©n√©raux */
        .main-header {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #dee2e6;
        }

        .params-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .param-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .param-group label {
            color: #495057;
            font-size: 0.9em;
            font-weight: 500;
        }

        .param-group input, .param-group select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .param-group input:focus, .param-group select:focus {
            outline: none;
            border-color: #2a5ea5;
            box-shadow: 0 0 0 3px rgba(42, 94, 165, 0.1);
        }

        .param-group .help-text {
            font-size: 0.75em;
            color: #6c757d;
        }

        /* Contenu principal */
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a5ea5;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #495057;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s;
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #2a5ea5 0%, #1e4d8b 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42, 94, 165, 0.4);
        }

        .btn-add {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            width: 100%;
        }

        .btn-calculate {
            background: linear-gradient(135deg, #dc3545 0%, #c0392b 100%);
            font-size: 1.2em;
            padding: 15px 30px;
            width: 100%;
            margin-top: 20px;
        }

        .btn-export {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-import {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        /* Onglets des niveaux */
        .level-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .level-tab {
            padding: 8px 16px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .level-tab.active {
            background: linear-gradient(135deg, #2a5ea5 0%, #1e4d8b 100%);
            color: white;
            border-color: #2a5ea5;
        }

        /* Liste des pi√®ces */
        .room-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .room-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .room-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .room-details {
            color: #7f8c8d;
            font-size: 0.85em;
        }

        .room-actions {
            display: flex;
            gap: 5px;
        }

        .btn-edit {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .btn-remove:hover {
            background: #c0392b;
        }

        /* Zone de r√©sultats */
        .results-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* R√©sultats par niveau */
        .level-results {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a5ea5;
        }

        .level-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .nourrice-info {
            background: #e3f2fd;
            padding: 8px 15px;
            border-radius: 8px;
            color: #1565c0;
            font-weight: 500;
            border: 1px solid #90caf9;
        }

        /* Tableau des circuits */
        .circuit-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .circuit-table th {
            background: #1e4d8b;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }

        .circuit-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
        }

        .circuit-table tr:hover {
            background: #f8f9fa;
        }

        .debit-ok {
            color: #27ae60;
            font-weight: 600;
        }

        .debit-warning {
            color: #f39c12;
            font-weight: 600;
        }

        .debit-error {
            color: #e74c3c;
            font-weight: 600;
        }

        /* Section couronnes */
        .crown-section {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .crown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .crown-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .crown-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .crown-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Dispatching des couronnes */
        .dispatching-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .crown-dispatch {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #2a5ea5;
        }

        .crown-dispatch-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .crown-circuits {
            padding-left: 20px;
            color: #495057;
        }

        .crown-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }

        /* Alertes */
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }

        /* Donn√©es globales */
        .global-data {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .global-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .global-data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .global-data-label {
            color: #495057;
            font-weight: 500;
        }

        .global-data-value {
            color: #1565c0;
            font-weight: 600;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* Popup projets sauvegard√©s */
        .saved-projects {
            background: white;
            padding: 15px;
            border-radius: 10px;
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            width: 400px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .saved-projects.show {
            display: block;
        }

        .saved-projects h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .saved-projects select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            background: white;
            margin-bottom: 10px;
            height: 200px;
        }

        .saved-projects-buttons {
            display: flex;
            gap: 10px;
        }

        .saved-projects-buttons button {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Modal pour √©dition */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-header h3 {
            color: #2c3e50;
            margin: 0;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .import-file {
            display: none;
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header avec logo ADI -->
        <div class="header">
            <div class="logo-section">
                <div class="logo-container">
                    <div>
                        <div class="logo-text">
                            <span class="logo-letter letter-a">A</span>
                            <span class="logo-point">.</span>
                            <span class="logo-letter letter-d">D</span>
                            <span class="logo-point">.</span>
                            <span class="logo-letter letter-i">I</span>
                            <span class="logo-point">.</span>
                        </div>
                        <div class="logo-subtitle">Assistance D√©pannage Installation</div>
                    </div>
                </div>
                <div class="header-title">
                    <h1>Calculateur de Plancher Chauffant Pro</h1>
                    <p>Version 4.0 - √âtude compl√®te avec analyse hydraulique</p>
                </div>
            </div>

            <div class="project-controls">
                <button onclick="saveProject()">üíæ Sauvegarder</button>
                <button onclick="exportToJSON()">üì• Export JSON</button>
                <button onclick="document.getElementById('importFile').click()">üì§ Import JSON</button>
                <input type="file" id="importFile" class="import-file" accept=".json" onchange="importFromJSON(event)">
                <button onclick="toggleSavedProjects()">üìÅ Projets locaux</button>
                <button onclick="newProject()">üìÑ Nouveau</button>
                
                <div class="saved-projects" id="savedProjectsDiv">
                    <h3>üìÅ Projets sauvegard√©s</h3>
                    <select id="savedProjectsList" size="8">
                        <option value="">-- Choisir un projet --</option>
                    </select>
                    <div class="saved-projects-buttons">
                        <button onclick="loadSelectedProject()" style="background: #27ae60; color: white;">üìÇ Charger</button>
                        <button onclick="deleteSelectedProject()" style="background: #e74c3c; color: white;">üóëÔ∏è Supprimer</button>
                        <button onclick="toggleSavedProjects()" style="background: #95a5a6; color: white;">‚úï Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Client -->
        <div class="client-section">
            <div class="client-inputs">
                <label>Client :</label>
                <input type="text" id="clientName" placeholder="Nom">
                <input type="text" id="clientFirstName" placeholder="Pr√©nom">
            </div>
        </div>

        <!-- Param√®tres g√©n√©raux -->
        <div class="main-header">
            <div class="params-section">
                <div class="param-group">
                    <label>Surface totale (m¬≤)</label>
                    <input type="number" id="totalArea" placeholder="Ex: 150" step="0.1">
                </div>
                <div class="param-group">
                    <label>D√©perdition totale (W)</label>
                    <input type="number" id="totalLoss" placeholder="Ex: 8000" step="10">
                    <span class="help-text">Incluant radiateurs</span>
                </div>
                <div class="param-group">
                    <label>Diam√®tre tube</label>
                    <select id="tubeDiameter">
                        <option value="16" selected>BAO 16x1.5 (√òint 13mm)</option>
                        <option value="20">BAO 20x1.9 (√òint 16.2mm)</option>
                    </select>
                </div>
                <div class="param-group">
                    <label>Pas de pose (cm)</label>
                    <select id="spacing">
                        <option value="10">10 cm - Zones froides</option>
                        <option value="15" selected>15 cm - Standard</option>
                        <option value="20">20 cm - Temp√©r√©</option>
                        <option value="25">25 cm - Faible</option>
                    </select>
                </div>
                <div class="param-group">
                    <label>Marge d'erreur (%)</label>
                    <input type="number" id="margin" value="5" min="5" max="25" step="1">
                    <span class="help-text">Raccords et courbes</span>
                </div>
                <div class="param-group">
                    <label>ŒîT (¬∞C)</label>
                    <input type="number" id="deltaT" value="5" min="5" max="10" step="1">
                    <span class="help-text">√âcart d√©part/retour</span>
                </div>
                <div class="param-group">
                    <label>Type d√©bitm√®tre</label>
                    <select id="flowmeterType">
                        <option value="5" selected>Standard (max 5 l/min)</option>
                        <option value="6">Haut d√©bit (max 6 l/min)</option>
                    </select>
                </div>
                <div class="param-group" style="align-self: center;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="corridorHeating" checked>
                        <label for="corridorHeating">Couloirs par passage</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>üè† Gestion des Pi√®ces</h2>
                    
                    <div class="level-tabs" id="levelTabs">
                        <div class="level-tab active" data-level="0" onclick="selectLevel(0)">RDC</div>
                    </div>
                    <button class="btn btn-add" onclick="addLevel()" style="margin-bottom: 15px;">‚ûï Ajouter un √©tage</button>

                    <div class="form-group">
                        <label>Nom de la pi√®ce</label>
                        <input type="text" id="roomName" placeholder="Ex: Salon">
                    </div>

                    <div class="form-group">
                        <label>Surface (m¬≤)</label>
                        <input type="number" id="roomArea" placeholder="Ex: 25" step="0.1">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="isCorridor">
                        <label for="isCorridor">C'est un couloir/circulation</label>
                    </div>

                    <button class="btn btn-add" onclick="addRoom()">‚ûï Ajouter la pi√®ce</button>

                    <div class="room-list" id="roomsList"></div>
                </div>

                <button class="btn btn-calculate" onclick="calculateAll()">üîÑ CALCULER</button>
            </div>

            <div class="results-area">
                <div class="card">
                    <h2>üìä R√©sultats de l'√âtude</h2>
                    <button class="btn btn-export" onclick="exportPDF()">üì• Exporter PDF</button>
                    <div id="results" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour √©diter une pi√®ce -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier la pi√®ce</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nom de la pi√®ce</label>
                    <input type="text" id="editRoomName">
                </div>
                <div class="form-group">
                    <label>Surface (m¬≤)</label>
                    <input type="number" id="editRoomArea" step="0.1">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="editIsCorridor">
                    <label for="editIsCorridor">C'est un couloir/circulation</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveRoomEdit()">üíæ Valider</button>
                <button class="btn" style="background: #95a5a6;" onclick="closeEditModal()">‚úï Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // Structure de donn√©es am√©lior√©e
        let data = {
            client: {
                name: '',
                firstName: ''
            },
            levels: {
                0: { name: 'RDC', rooms: [] }
            },
            currentLevel: 0,
            editingRoomId: null
        };

        // Configuration des diam√®tres
        const tubeConfig = {
            '16': {
                name: 'BAO 16x1.5',
                innerDiameter: 0.013, // m
                section: 0.000133, // m¬≤
                volumePerMeter: 0.133, // litres/m
                crown120: '436LK',
                crown240: 'A2KXW',
                maxSpeed: 0.8, // m/s
                optimalSpeed: 0.5 // m/s
            },
            '20': {
                name: 'BAO 20x1.9',
                innerDiameter: 0.0162, // m
                section: 0.000206, // m¬≤
                volumePerMeter: 0.206, // litres/m
                crown120: '1027B',
                crown240: '431HW',
                maxSpeed: 0.8,
                optimalSpeed: 0.5
            }
        };

        // Gestion du stockage local (15 projets max)
        const STORAGE_KEY = 'plancherChauffantProjectsV4';
        const MAX_PROJECTS = 15;

        // Charger les projets sauvegard√©s au d√©marrage
        function loadProjectsFromStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        // Sauvegarder un projet
        function saveProject() {
            const clientName = document.getElementById('clientName').value;
            const clientFirstName = document.getElementById('clientFirstName').value;
            
            if (!clientName || !clientFirstName) {
                alert('Veuillez renseigner le nom et pr√©nom du client');
                return;
            }

            const projectData = collectProjectData();
            const date = new Date();
            const dateStr = date.toISOString().slice(2,10).replace(/-/g, '');
            const timeStr = date.toTimeString().slice(0,5).replace(':', 'h');
            const projectName = `${clientName} ${clientFirstName} - ${dateStr} ${timeStr}`;

            const projects = loadProjectsFromStorage();
            projects[projectName] = projectData;
            
            // Limiter au nombre maximum de projets
            const projectKeys = Object.keys(projects);
            if (projectKeys.length > MAX_PROJECTS) {
                const toDelete = projectKeys.sort((a, b) => 
                    projects[a].savedDate.localeCompare(projects[b].savedDate)
                ).slice(0, projectKeys.length - MAX_PROJECTS);
                toDelete.forEach(key => delete projects[key]);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
            alert(`‚úÖ Projet "${projectName}" sauvegard√© !`);
            updateSavedProjectsList();
        }

        // Collecter les donn√©es du projet
        function collectProjectData() {
            return {
                client: {
                    name: document.getElementById('clientName').value,
                    firstName: document.getElementById('clientFirstName').value
                },
                params: {
                    totalArea: document.getElementById('totalArea').value,
                    totalLoss: document.getElementById('totalLoss').value,
                    tubeDiameter: document.getElementById('tubeDiameter').value,
                    spacing: document.getElementById('spacing').value,
                    margin: document.getElementById('margin').value,
                    deltaT: document.getElementById('deltaT').value,
                    flowmeterType: document.getElementById('flowmeterType').value,
                    corridorHeating: document.getElementById('corridorHeating').checked
                },
                levels: data.levels,
                savedDate: new Date().toISOString()
            };
        }

        // Export vers JSON
        function exportToJSON() {
            const clientName = document.getElementById('clientName').value || 'projet';
            const clientFirstName = document.getElementById('clientFirstName').value || '';
            const date = new Date().toISOString().slice(0,10);
            
            const projectData = collectProjectData();
            const dataStr = JSON.stringify(projectData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `plancher_chauffant_${clientName}_${clientFirstName}_${date}.json`;
            link.click();
        }

        // Import depuis JSON
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    loadProjectData(projectData);
                    alert('‚úÖ Projet import√© avec succ√®s !');
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import du fichier');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Charger les donn√©es d'un projet
        function loadProjectData(project) {
            document.getElementById('clientName').value = project.client.name || '';
            document.getElementById('clientFirstName').value = project.client.firstName || '';
            document.getElementById('totalArea').value = project.params.totalArea || '';
            document.getElementById('totalLoss').value = project.params.totalLoss || '';
            document.getElementById('tubeDiameter').value = project.params.tubeDiameter || '16';
            document.getElementById('spacing').value = project.params.spacing || '15';
            document.getElementById('margin').value = project.params.margin || '5';
            document.getElementById('deltaT').value = project.params.deltaT || '5';
            document.getElementById('flowmeterType').value = project.params.flowmeterType || '5';
            document.getElementById('corridorHeating').checked = project.params.corridorHeating !== false;
            
            data.levels = project.levels || { 0: { name: 'RDC', rooms: [] } };
            data.currentLevel = 0;
            
            updateLevelTabs();
            updateRoomsList();
        }

        // Afficher/masquer les projets sauvegard√©s
        function toggleSavedProjects() {
            const div = document.getElementById('savedProjectsDiv');
            div.classList.toggle('show');
            if (div.classList.contains('show')) {
                updateSavedProjectsList();
            }
        }

        // Mettre √† jour la liste des projets
        function updateSavedProjectsList() {
            const select = document.getElementById('savedProjectsList');
            const projects = loadProjectsFromStorage();
            
            select.innerHTML = '<option value="">-- Choisir un projet --</option>';
            
            const sortedProjects = Object.keys(projects).sort((a, b) => 
                projects[b].savedDate.localeCompare(projects[a].savedDate)
            );
            
            sortedProjects.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // Charger un projet s√©lectionn√©
        function loadSelectedProject() {
            const select = document.getElementById('savedProjectsList');
            const projectName = select.value;
            
            if (!projectName) {
                alert('Veuillez s√©lectionner un projet');
                return;
            }
            
            const projects = loadProjectsFromStorage();
            const project = projects[projectName];
            
            if (project) {
                loadProjectData(project);
                alert(`‚úÖ Projet "${projectName}" charg√© !`);
                toggleSavedProjects();
            }
        }

        // Supprimer un projet
        function deleteSelectedProject() {
            const select = document.getElementById('savedProjectsList');
            const projectName = select.value;
            
            if (!projectName) {
                alert('Veuillez s√©lectionner un projet');
                return;
            }
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer le projet "${projectName}" ?`)) {
                const projects = loadProjectsFromStorage();
                delete projects[projectName];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
                updateSavedProjectsList();
                alert(`‚úÖ Projet supprim√©`);
            }
        }

        // Nouveau projet
        function newProject() {
            if (confirm('Cr√©er un nouveau projet ? Les donn√©es non sauvegard√©es seront perdues.')) {
                document.getElementById('clientName').value = '';
                document.getElementById('clientFirstName').value = '';
                document.getElementById('totalArea').value = '';
                document.getElementById('totalLoss').value = '';
                document.getElementById('tubeDiameter').value = '16';
                document.getElementById('spacing').value = '15';
                document.getElementById('margin').value = '5';
                document.getElementById('deltaT').value = '5';
                document.getElementById('flowmeterType').value = '5';
                document.getElementById('corridorHeating').checked = true;
                
                data.levels = { 0: { name: 'RDC', rooms: [] } };
                data.currentLevel = 0;
                
                updateLevelTabs();
                updateRoomsList();
                document.getElementById('results').innerHTML = '';
            }
        }

        // Ajouter un niveau
        function addLevel() {
            const levelCount = Object.keys(data.levels).length;
            const levelName = prompt(`Nom du niveau ${levelCount + 1}:`, `√âtage ${levelCount}`);
            if (levelName) {
                data.levels[levelCount] = { name: levelName, rooms: [] };
                updateLevelTabs();
                selectLevel(levelCount);
            }
        }

        // Mettre √† jour les onglets de niveaux
        function updateLevelTabs() {
            const tabs = document.getElementById('levelTabs');
            tabs.innerHTML = '';
            
            Object.keys(data.levels).forEach(level => {
                const tab = document.createElement('div');
                tab.className = 'level-tab';
                if (parseInt(level) === data.currentLevel) {
                    tab.classList.add('active');
                }
                tab.dataset.level = level;
                tab.textContent = data.levels[level].name;
                tab.onclick = () => selectLevel(parseInt(level));
                tabs.appendChild(tab);
            });
        }

        // S√©lectionner un niveau
        function selectLevel(level) {
            data.currentLevel = level;
            document.querySelectorAll('.level-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.level) === level);
            });
            updateRoomsList();
        }

        // Ajouter une pi√®ce
        function addRoom() {
            const name = document.getElementById('roomName').value;
            const area = parseFloat(document.getElementById('roomArea').value);
            const isCorridor = document.getElementById('isCorridor').checked;

            if (!name || !area) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const room = {
                id: Date.now(),
                name: name,
                area: area,
                isCorridor: isCorridor,
                level: data.currentLevel
            };

            data.levels[data.currentLevel].rooms.push(room);
            
            document.getElementById('roomName').value = '';
            document.getElementById('roomArea').value = '';
            document.getElementById('isCorridor').checked = false;
            
            updateRoomsList();
        }

        // √âditer une pi√®ce
        function editRoom(id) {
            const room = data.levels[data.currentLevel].rooms.find(r => r.id === id);
            if (!room) return;
            
            data.editingRoomId = id;
            document.getElementById('editRoomName').value = room.name;
            document.getElementById('editRoomArea').value = room.area;
            document.getElementById('editIsCorridor').checked = room.isCorridor;
            
            document.getElementById('editModal').classList.add('show');
        }

        // Sauvegarder l'√©dition
        function saveRoomEdit() {
            const room = data.levels[data.currentLevel].rooms.find(r => r.id === data.editingRoomId);
            if (!room) return;
            
            const name = document.getElementById('editRoomName').value;
            const area = parseFloat(document.getElementById('editRoomArea').value);
            
            if (!name || !area) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            room.name = name;
            room.area = area;
            room.isCorridor = document.getElementById('editIsCorridor').checked;
            
            closeEditModal();
            updateRoomsList();
        }

        // Fermer la modal d'√©dition
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            data.editingRoomId = null;
        }

        // Supprimer une pi√®ce
        function removeRoom(id) {
            data.levels[data.currentLevel].rooms = data.levels[data.currentLevel].rooms.filter(r => r.id !== id);
            updateRoomsList();
        }

        // Mettre √† jour la liste des pi√®ces
        function updateRoomsList() {
            const list = document.getElementById('roomsList');
            const rooms = data.levels[data.currentLevel].rooms;
            
            if (rooms.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center;">Aucune pi√®ce ajout√©e</p>';
                return;
            }

            list.innerHTML = '';
            rooms.forEach(room => {
                const item = document.createElement('div');
                item.className = 'room-item';
                
                const info = document.createElement('div');
                info.className = 'room-info';
                
                const name = document.createElement('div');
                name.className = 'room-name';
                name.textContent = room.name + (room.isCorridor ? ' üö∂' : '');
                
                const details = document.createElement('div');
                details.className = 'room-details';
                details.textContent = `${room.area} m¬≤`;
                
                info.appendChild(name);
                info.appendChild(details);
                
                const actions = document.createElement('div');
                actions.className = 'room-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-edit';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.onclick = () => editRoom(room.id);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove';
                removeBtn.textContent = '‚ùå';
                removeBtn.onclick = () => removeRoom(room.id);
                
                actions.appendChild(editBtn);
                actions.appendChild(removeBtn);
                
                item.appendChild(info);
                item.appendChild(actions);
                list.appendChild(item);
            });
        }

        // Calcul de la longueur de tube
        function calculateTubeLength(area, spacing, margin, isCorridor, corridorHeating) {
            if (isCorridor && corridorHeating) {
                return 0;
            }
            const spacingM = spacing / 100;
            const baseLength = area / spacingM;
            const marginFactor = 1 + (margin / 100);
            return baseLength * marginFactor;
        }

        // √âquilibrage des boucles
        function balanceCircuits(tubeLength, maxCircuitLength = 120) {
            if (tubeLength <= maxCircuitLength) {
                return [tubeLength];
            }
            const numCircuits = Math.ceil(tubeLength / maxCircuitLength);
            const targetLength = tubeLength / numCircuits;
            const circuits = [];
            for (let i = 0; i < numCircuits; i++) {
                circuits.push(targetLength);
            }
            return circuits;
        }

        // Calcul du d√©bit
        function calculateFlowRate(power, deltaT) {
            const c = 4186;
            const flowKgS = power / (c * deltaT);
            const flowLMin = flowKgS * 60;
            return flowLMin;
        }

        // Calcul de la vitesse dans le tube
        function calculateSpeed(flowLMin, diameter) {
            const config = tubeConfig[diameter];
            const flowM3S = flowLMin / 60000; // l/min vers m¬≥/s
            const speed = flowM3S / config.section;
            return speed;
        }

        // Optimisation des couronnes
        function optimizeCrowns(allCircuits, diameter) {
            const crowns = [];
            const sortedCircuits = [...allCircuits].sort((a, b) => b.length - a.length);
            
            while (sortedCircuits.length > 0) {
                // Essayer d'abord une couronne de 240m
                const crown240 = { type: 240, circuits: [], used: 0, waste: 0 };
                let remaining240 = 240;
                
                for (let i = 0; i < sortedCircuits.length; i++) {
                    if (sortedCircuits[i].length <= remaining240) {
                        crown240.circuits.push(sortedCircuits[i]);
                        crown240.used += sortedCircuits[i].length;
                        remaining240 -= sortedCircuits[i].length;
                        sortedCircuits.splice(i, 1);
                        i--;
                    }
                }
                
                if (crown240.circuits.length > 0) {
                    crown240.waste = 240 - crown240.used;
                    crowns.push(crown240);
                    continue;
                }
                
                // Si aucun circuit ne rentre dans 240m, essayer 120m
                const crown120 = { type: 120, circuits: [], used: 0, waste: 0 };
                let remaining120 = 120;
                
                for (let i = 0; i < sortedCircuits.length; i++) {
                    if (sortedCircuits[i].length <= remaining120) {
                        crown120.circuits.push(sortedCircuits[i]);
                        crown120.used += sortedCircuits[i].length;
                        remaining120 -= sortedCircuits[i].length;
                        sortedCircuits.splice(i, 1);
                        i--;
                    }
                }
                
                if (crown120.circuits.length > 0) {
                    crown120.waste = 120 - crown120.used;
                    crowns.push(crown120);
                } else {
                    // Circuit trop long pour une couronne
                    console.error('Circuit trop long pour une couronne:', sortedCircuits[0]);
                    sortedCircuits.shift();
                }
            }
            
            return crowns;
        }

        // Calcul principal
        function calculateAll() {
            const totalArea = parseFloat(document.getElementById('totalArea').value);
            const totalLoss = parseFloat(document.getElementById('totalLoss').value);
            const tubeDiameter = document.getElementById('tubeDiameter').value;
            const spacing = parseFloat(document.getElementById('spacing').value);
            const margin = parseFloat(document.getElementById('margin').value);
            const deltaT = parseFloat(document.getElementById('deltaT').value);
            const flowmeterType = parseFloat(document.getElementById('flowmeterType').value);
            const corridorHeating = document.getElementById('corridorHeating').checked;

            if (!totalArea || !totalLoss) {
                alert('Veuillez renseigner la surface totale et la d√©perdition totale');
                return;
            }

            const tubeConf = tubeConfig[tubeDiameter];
            
            let results = {
                levels: {},
                totalTubeLength: 0,
                totalActiveArea: 0,
                totalCircuits: 0,
                totalFlowRate: 0,
                totalVolume: 0,
                averageFlowPerMeter: 0,
                powerPerM2: totalLoss / totalArea,
                crowns: [],
                warnings: [],
                errors: [],
                tubeDiameter: tubeDiameter,
                tubeConfig: tubeConf
            };

            let allCircuits = [];

            Object.keys(data.levels).forEach(levelKey => {
                const level = data.levels[levelKey];
                let levelResults = {
                    name: level.name,
                    rooms: [],
                    totalTubeLength: 0,
                    totalArea: 0,
                    totalActiveArea: 0,
                    circuits: [],
                    nouriceSorties: 0
                };

                level.rooms.forEach(room => {
                    const tubeLength = calculateTubeLength(room.area, spacing, margin, room.isCorridor, corridorHeating);
                    
                    const roomResult = {
                        name: room.name,
                        area: room.area,
                        isCorridor: room.isCorridor,
                        tubeLength: tubeLength,
                        circuits: []
                    };

                    levelResults.totalArea += room.area;
                    if (!room.isCorridor || !corridorHeating) {
                        levelResults.totalActiveArea += room.area;
                    }

                    if (tubeLength > 0) {
                        const circuitLengths = balanceCircuits(tubeLength, 120);
                        const roomPowerPerM2 = totalLoss / totalArea;
                        const roomTotalPower = room.area * roomPowerPerM2;
                        
                        circuitLengths.forEach((circuitLength, index) => {
                            const circuitPower = roomTotalPower * (circuitLength / tubeLength);
                            const circuitFlow = calculateFlowRate(circuitPower, deltaT);
                            const circuitSpeed = calculateSpeed(circuitFlow, tubeDiameter);

                            const circuit = {
                                id: `${room.name}-C${index + 1}`,
                                roomName: room.name,
                                roomArea: room.area,
                                length: circuitLength,
                                power: circuitPower,
                                flowRate: circuitFlow,
                                speed: circuitSpeed
                            };

                            // V√©rifications
                            if (circuitFlow > flowmeterType) {
                                results.errors.push(`üö® "${circuit.id}" : ${circuitFlow.toFixed(2)} l/min > D√©bitm√®tre max ${flowmeterType} l/min`);
                            } else if (circuitFlow > 4) {
                                results.warnings.push(`‚ö†Ô∏è "${circuit.id}" : ${circuitFlow.toFixed(2)} l/min - Risque de bruit`);
                            }

                            if (circuitSpeed > tubeConf.maxSpeed) {
                                results.warnings.push(`‚ö†Ô∏è "${circuit.id}" : Vitesse ${circuitSpeed.toFixed(2)} m/s > Max ${tubeConf.maxSpeed} m/s`);
                            }

                            roomResult.circuits.push(circuit);
                            levelResults.circuits.push(circuit);
                            allCircuits.push(circuit);
                        });

                        if (circuitLengths.length > 1) {
                            results.warnings.push(`‚ÑπÔ∏è "${room.name}" : ${circuitLengths.length} circuits de ${circuitLengths[0].toFixed(0)}m`);
                        }
                    }

                    levelResults.totalTubeLength += tubeLength;
                    levelResults.rooms.push(roomResult);
                });

                levelResults.nouriceSorties = levelResults.circuits.length;
                results.levels[levelKey] = levelResults;
                results.totalTubeLength += levelResults.totalTubeLength;
                results.totalActiveArea += levelResults.totalActiveArea;
                results.totalCircuits += levelResults.circuits.length;
            });

            // Calculs finaux
            results.totalFlowRate = allCircuits.reduce((sum, circuit) => sum + circuit.flowRate, 0);
            results.totalVolume = results.totalTubeLength * tubeConf.volumePerMeter;
            results.averageFlowPerMeter = results.totalFlowRate / results.totalTubeLength;
            
            // Optimisation des couronnes
            results.crowns = optimizeCrowns(allCircuits, tubeDiameter);

            // V√©rifications
            const totalRoomArea = Object.values(data.levels).reduce((sum, level) => 
                sum + level.rooms.reduce((s, r) => s + r.area, 0), 0);

            if (Math.abs(totalRoomArea - totalArea) > 0.1) {
                results.warnings.push(`‚ö†Ô∏è Surface pi√®ces (${totalRoomArea.toFixed(1)} m¬≤) ‚â† Surface totale (${totalArea} m¬≤)`);
            }

            const coverageRatio = (results.totalActiveArea / totalArea) * 100;
            if (coverageRatio < 80) {
                results.warnings.push(`‚ö†Ô∏è Couverture: ${coverageRatio.toFixed(1)}% (recommand√© > 80%)`);
            }

            // Suggestion de changement de diam√®tre
            if (results.errors.some(e => e.includes('D√©bitm√®tre max')) && tubeDiameter === '16') {
                results.warnings.push(`üí° Suggestion: Passer en BAO 20x1.9 pour r√©duire les d√©bits`);
            }

            displayResults(results);
        }

        // Affichage des r√©sultats
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            let html = '';

            // Donn√©es globales
            html += '<div class="global-data">';
            html += '<h3 style="margin-bottom: 15px; color: #2c3e50;">üìä Donn√©es Globales</h3>';
            html += '<div class="global-data-grid">';
            html += `<div class="global-data-item">
                        <span class="global-data-label">Surface totale :</span>
                        <span class="global-data-value">${document.getElementById('totalArea').value} m¬≤</span>
                     </div>`;
            html += `<div class="global-data-item">
                        <span class="global-data-label">D√©perdition :</span>
                        <span class="global-data-value">${document.getElementById('totalLoss').value} W (${results.powerPerM2.toFixed(1)} W/m¬≤)</span>
                     </div>`;
            html += `<div class="global-data-item">
                        <span class="global-data-label">Longueur tubes :</span>
                        <span class="global-data-value">${results.totalTubeLength.toFixed(0)} m</span>
                     </div>`;
            html += `<div class="global-data-item">
                        <span class="global-data-label">Volume d'eau :</span>
                        <span class="global-data-value">${results.totalVolume.toFixed(1)} litres</span>
                     </div>`;
            html += `<div class="global-data-item">
                        <span class="global-data-label">D√©bit total :</span>
                        <span class="global-data-value">${results.totalFlowRate.toFixed(1)} l/min</span>
                     </div>`;
            html += `<div class="global-data-item">
                        <span class="global-data-label">D√©bit moyen :</span>
                        <span class="global-data-value">${results.averageFlowPerMeter.toFixed(3)} l/min/m</span>
                     </div>`;
            html += '</div>';
            html += '</div>';

            // R√©sum√© statistiques
            html += '<div class="result-summary">';
            html += `<div class="stat-card">
                        <div class="stat-value">${results.totalCircuits}</div>
                        <div class="stat-label">Circuits</div>
                     </div>`;
            html += `<div class="stat-card">
                        <div class="stat-value">${Object.keys(results.levels).length}</div>
                        <div class="stat-label">Nourices</div>
                     </div>`;
            
            const crown240Count = results.crowns.filter(c => c.type === 240).length;
            const crown120Count = results.crowns.filter(c => c.type === 120).length;
            
            html += `<div class="stat-card">
                        <div class="stat-value">${crown240Count}</div>
                        <div class="stat-label">Couronnes 240m</div>
                     </div>`;
            html += `<div class="stat-card">
                        <div class="stat-value">${crown120Count}</div>
                        <div class="stat-label">Couronnes 120m</div>
                     </div>`;
            
            const totalWaste = results.crowns.reduce((sum, c) => sum + c.waste, 0);
            const efficiency = ((results.totalTubeLength / (results.totalTubeLength + totalWaste)) * 100).toFixed(1);
            
            html += `<div class="stat-card">
                        <div class="stat-value">${totalWaste.toFixed(0)} m</div>
                        <div class="stat-label">Chutes totales</div>
                     </div>`;
            html += `<div class="stat-card">
                        <div class="stat-value">${efficiency}%</div>
                        <div class="stat-label">Efficacit√©</div>
                     </div>`;
            html += '</div>';

            // Section couronnes avec r√©f√©rences
            html += '<div class="crown-section">';
            html += `<h3>üì¶ Besoins en Couronnes (${results.tubeConfig.name})</h3>`;
            html += '<div class="crown-grid">';
            html += `<div class="crown-item">
                        <div class="crown-value">${crown240Count}</div>
                        <div class="crown-label">240m (${results.tubeConfig.crown240})</div>
                     </div>`;
            html += `<div class="crown-item">
                        <div class="crown-value">${crown120Count}</div>
                        <div class="crown-label">120m (${results.tubeConfig.crown120})</div>
                     </div>`;
            html += `<div class="crown-item">
                        <div class="crown-value">${crown240Count + crown120Count}</div>
                        <div class="crown-label">Total couronnes</div>
                     </div>`;
            html += '</div></div>';

            // Dispatching des couronnes
            html += '<div class="dispatching-section">';
            html += '<h3 style="margin-bottom: 15px; color: #2c3e50;">üîß R√©partition des Couronnes</h3>';
            
            results.crowns.forEach((crown, index) => {
                const ref = crown.type === 240 ? results.tubeConfig.crown240 : results.tubeConfig.crown120;
                html += '<div class="crown-dispatch">';
                html += `<div class="crown-dispatch-title">üîµ Couronne ${crown.type}m n¬∞${index + 1} (r√©f: ${ref})</div>`;
                html += '<div class="crown-circuits">';
                crown.circuits.forEach(circuit => {
                    html += `‚Ä¢ ${circuit.id} : ${circuit.length.toFixed(0)}m<br>`;
                });
                html += '</div>';
                html += '<div class="crown-stats">';
                html += `<span>üìä Utilis√© : ${crown.used.toFixed(0)}m</span>`;
                html += `<span>üî∏ Chute : ${crown.waste.toFixed(0)}m</span>`;
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';

            // D√©tails par niveau
            Object.keys(results.levels).forEach(levelKey => {
                const level = results.levels[levelKey];
                html += '<div class="level-results">';
                html += '<div class="level-header">';
                html += `<div class="level-title">üìç ${level.name} - ${level.totalArea.toFixed(1)} m¬≤</div>`;
                html += `<div class="nourrice-info">üîß Nourice ${level.name}: ${level.nouriceSorties} sorties</div>`;
                html += '</div>';

                if (level.circuits.length > 0) {
                    html += '<table class="circuit-table">';
                    html += '<thead><tr>';
                    html += '<th>N¬∞</th>';
                    html += '<th>Pi√®ce</th>';
                    html += '<th>Surface (m¬≤)</th>';
                    html += '<th>Long. (m)</th>';
                    html += '<th>D√©bit (l/min)</th>';
                    html += '<th>Vitesse (m/s)</th>';
                    html += '<th>Puiss. (W)</th>';
                    html += '</tr></thead>';
                    html += '<tbody>';
                    
                    level.circuits.forEach((circuit, index) => {
                        let debitClass = 'debit-ok';
                        if (circuit.flowRate > 5) debitClass = 'debit-error';
                        else if (circuit.flowRate > 4) debitClass = 'debit-warning';
                        
                        let speedClass = '';
                        if (circuit.speed > 0.8) speedClass = 'debit-error';
                        else if (circuit.speed > 0.5) speedClass = 'debit-warning';
                        else speedClass = 'debit-ok';
                        
                        html += `<tr>
                                    <td>${index + 1}</td>
                                    <td>${circuit.roomName}</td>
                                    <td>${circuit.roomArea.toFixed(1)}</td>
                                    <td>${circuit.length.toFixed(0)}</td>
                                    <td class="${debitClass}">${circuit.flowRate.toFixed(2)}</td>
                                    <td class="${speedClass}">${circuit.speed.toFixed(2)}</td>
                                    <td>${circuit.power.toFixed(0)}</td>
                                 </tr>`;
                    });
                    
                    html += '</tbody></table>';
                }

                // Pi√®ces chauff√©es par passage
                const corridors = level.rooms.filter(r => r.isCorridor && r.tubeLength === 0);
                if (corridors.length > 0) {
                    html += '<div style="margin-top: 10px; color: #7f8c8d; font-size: 0.9em;">';
                    html += 'üö∂ Couloirs chauff√©s par passage : ';
                    html += corridors.map(c => `${c.name} (${c.area} m¬≤)`).join(', ');
                    html += '</div>';
                }

                html += '</div>';
            });

            // Erreurs
            if (results.errors.length > 0) {
                results.errors.forEach(e => {
                    html += `<div class="alert alert-error">${e}</div>`;
                });
            }

            // Avertissements
            if (results.warnings.length > 0) {
                results.warnings.forEach(w => {
                    html += `<div class="alert alert-warning">${w}</div>`;
                });
            }

            // Message de succ√®s
            if (results.warnings.length === 0 && results.errors.length === 0) {
                html += '<div class="alert alert-success">‚úÖ √âtude valid√©e - Tous les param√®tres sont conformes</div>';
            }

            resultsDiv.innerHTML = html;
        }

        // Export PDF avec logo ADI
        function exportPDF() {
            const results = document.getElementById('results').innerHTML;
            if (!results) {
                alert('Veuillez d\'abord calculer les r√©sultats');
                return;
            }

            const clientName = document.getElementById('clientName').value || 'Client';
            const clientFirstName = document.getElementById('clientFirstName').value || '';
            const date = new Date().toLocaleDateString('fr-FR');

            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>√âtude Plancher Chauffant - ADI</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
            printWindow.document.write('.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e4d8b; padding-bottom: 20px; }');
            printWindow.document.write('.logo { font-family: "Brush Script MT", cursive; font-size: 3em; font-weight: bold; font-style: italic; margin-bottom: 10px; }');
            printWindow.document.write('.letter-a { color: #1e4d8b; }');
            printWindow.document.write('.letter-d { color: #dc3545; }');
            printWindow.document.write('.letter-i { color: #00a8e8; }');
            printWindow.document.write('.logo-point { color: #333; font-size: 0.8em; position: relative; bottom: -5px; }');
            printWindow.document.write('.subtitle { font-size: 1em; color: #666; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 20px; }');
            printWindow.document.write('h1 { color: #2c3e50; }');
            printWindow.document.write('h2 { color: #34495e; margin-top: 20px; }');
            printWindow.document.write('.client-info { background: #ecf0f1; padding: 15px; margin-bottom: 20px; border-radius: 5px; }');
            printWindow.document.write('.global-data { background: #e8f4fd; padding: 15px; margin: 20px 0; }');
            printWindow.document.write('.stat-card { display: inline-block; margin: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; }');
            printWindow.document.write('.circuit-table { width: 100%; border-collapse: collapse; margin: 15px 0; }');
            printWindow.document.write('.circuit-table th { background: #1e4d8b; color: white; padding: 8px; }');
            printWindow.document.write('.circuit-table td { border: 1px solid #ddd; padding: 6px; }');
            printWindow.document.write('.crown-section { background: #e8f5e9; padding: 15px; margin: 20px 0; border-radius: 5px; }');
            printWindow.document.write('.dispatching-section { background: #f8f9fa; padding: 15px; margin: 20px 0; }');
            printWindow.document.write('.crown-dispatch { background: white; padding: 10px; margin: 10px 0; border-left: 4px solid #2a5ea5; }');
            printWindow.document.write('.level-results { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }');
            printWindow.document.write('.nourrice-info { background: #e3f2fd; padding: 5px 10px; border-radius: 5px; display: inline-block; margin-bottom: 10px; color: #1565c0; }');
            printWindow.document.write('.debit-ok { color: #27ae60; font-weight: 600; }');
            printWindow.document.write('.debit-warning { color: #f39c12; font-weight: 600; }');
            printWindow.document.write('.debit-error { color: #e74c3c; font-weight: 600; }');
            printWindow.document.write('@media print { body { font-size: 11px; } .circuit-table { page-break-inside: avoid; } }');
            printWindow.document.write('</style></head><body>');
            
            printWindow.document.write('<div class="header">');
            printWindow.document.write('<div class="logo">');
            printWindow.document.write('<span class="letter-a">A</span><span class="logo-point">.</span>');
            printWindow.document.write('<span class="letter-d">D</span><span class="logo-point">.</span>');
            printWindow.document.write('<span class="letter-i">I</span><span class="logo-point">.</span>');
            printWindow.document.write('</div>');
            printWindow.document.write('<div class="subtitle">Assistance D√©pannage Installation</div>');
            printWindow.document.write('<h1>√âTUDE PLANCHER CHAUFFANT</h1>');
            printWindow.document.write('<p>Document g√©n√©r√© le ' + date + '</p>');
            printWindow.document.write('</div>');
            
            printWindow.document.write('<div class="client-info">');
            printWindow.document.write('<h2>INFORMATIONS CLIENT</h2>');
            printWindow.document.write(`<p><strong>Nom :</strong> ${clientName} ${clientFirstName}</p>`);
            printWindow.document.write(`<p><strong>Surface totale :</strong> ${document.getElementById('totalArea').value} m¬≤</p>`);
            printWindow.document.write(`<p><strong>D√©perdition totale :</strong> ${document.getElementById('totalLoss').value} W</p>`);
            printWindow.document.write(`<p><strong>Tube :</strong> ${tubeConfig[document.getElementById('tubeDiameter').value].name}</p>`);
            printWindow.document.write(`<p><strong>Pas de pose :</strong> ${document.getElementById('spacing').value} cm</p>`);
            printWindow.document.write(`<p><strong>Marge :</strong> ${document.getElementById('margin').value} %</p>`);
            printWindow.document.write(`<p><strong>ŒîT :</strong> ${document.getElementById('deltaT').value} ¬∞C</p>`);
            printWindow.document.write('</div>');
            
            printWindow.document.write('<h2>R√âSULTATS DE L\'√âTUDE</h2>');
            printWindow.document.write(results);
            
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // Initialisation
        updateRoomsList();
        updateSavedProjectsList();
    </script>
</body>
</html>